# An√°lise Comparativa: Datasets de Notas Fiscais Eletr√¥nicas (NF-e)

**Data da An√°lise:** 28 de Outubro de 2025  
**Arquivos Analisados:**
- `data/202505_NFe_NotaFiscal.csv`
- `data/202505_NFe_NotaFiscalItem.csv`

---

## üìä Vis√£o Geral dos Arquivos

### Tamanhos e Caracter√≠sticas

| Arquivo | Tamanho | Colunas | Tipo |
|---------|---------|---------|------|
| **202505_NFe_NotaFiscal.csv** | 67.09 MB | 21 | Cabe√ßalho da NF-e |
| **202505_NFe_NotaFiscalItem.csv** | 296.30 MB | 27 | Detalhamento de Itens |

**Propor√ß√£o:** O arquivo de itens √© **4.4x maior**, indicando que cada nota possui em m√©dia m√∫ltiplos produtos.

**Encoding:** `latin-1` (ISO-8859-1)  
**Separador:** `;` (ponto e v√≠rgula)

---

## üèóÔ∏è Estrutura dos Arquivos

### 202505_NFe_NotaFiscal.csv (21 colunas)

**Representa:** Dados consolidados do **cabe√ßalho** de cada nota fiscal eletr√¥nica.

#### Colunas:

1. **CHAVE DE ACESSO** - Identificador √∫nico da NF-e (44 d√≠gitos)
2. **MODELO** - Modelo da nota (ex: "55 - NF-E EMITIDA EM SUBSTITUI√á√ÉO AO MODELO 1 OU 1A")
3. **S√âRIE** - S√©rie da nota fiscal
4. **N√öMERO** - N√∫mero sequencial da nota
5. **NATUREZA DA OPERA√á√ÉO** - Tipo de opera√ß√£o fiscal
6. **DATA EMISS√ÉO** - Data de emiss√£o da nota
7. **EVENTO MAIS RECENTE** - √öltimo evento da nota (ex: "Autoriza√ß√£o de Uso")
8. **DATA/HORA EVENTO MAIS RECENTE** - Timestamp do √∫ltimo evento
9. **CPF/CNPJ Emitente** - Documento do emitente
10. **RAZ√ÉO SOCIAL EMITENTE** - Nome empresarial do emitente
11. **INSCRI√á√ÉO ESTADUAL EMITENTE** - IE do emitente
12. **UF EMITENTE** - Estado do emitente
13. **MUNIC√çPIO EMITENTE** - Cidade do emitente
14. **CNPJ DESTINAT√ÅRIO** - Documento do destinat√°rio
15. **NOME DESTINAT√ÅRIO** - Nome do destinat√°rio
16. **UF DESTINAT√ÅRIO** - Estado do destinat√°rio
17. **INDICADOR IE DESTINAT√ÅRIO** - Tipo de contribuinte
18. **DESTINO DA OPERA√á√ÉO** - Interno/Interestadual/Internacional
19. **CONSUMIDOR FINAL** - Flag de consumidor final
20. **PRESEN√áA DO COMPRADOR** - Modalidade de compra
21. **VALOR NOTA FISCAL** - **Valor total da nota**

#### Exemplo de Registro:

```
CHAVE: 13250505914165000192550030000116841779221343
EMITENTE: CARBOXI INDUSTRIA E COMERCIO DE GASES LTDA (AM)
DESTINAT√ÅRIO: DISTRITO SANITARIO ESPECIAL INDIGENA YANOMAMI (RR)
VALOR TOTAL: R$ 4.603,42
DATA: 01/05/2025
```

---

### 202505_NFe_NotaFiscalItem.csv (27 colunas)

**Representa:** Detalhamento **linha a linha** de cada produto/servi√ßo da nota fiscal.

#### Colunas (18 em comum + 9 exclusivas):

**Colunas Compartilhadas (1-18):**
- Mesmas colunas de identifica√ß√£o da nota (CHAVE, MODELO, S√âRIE, etc.)
- Dados do emitente e destinat√°rio

**Colunas Exclusivas de Itens (19-27):**

19. **N√öMERO PRODUTO** - Sequ√™ncia do item na nota (1, 2, 3...)
20. **DESCRI√á√ÉO DO PRODUTO/SERVI√áO** - Descri√ß√£o completa do item
21. **C√ìDIGO NCM/SH** - Nomenclatura Comum do Mercosul
22. **NCM/SH (TIPO DE PRODUTO)** - Categoria fiscal do produto
23. **CFOP** - C√≥digo Fiscal de Opera√ß√µes e Presta√ß√µes
24. **QUANTIDADE** - Quantidade comercializada
25. **UNIDADE** - Unidade de medida (M3, KG, UN, LT, etc.)
26. **VALOR UNIT√ÅRIO** - Pre√ßo por unidade
27. **VALOR TOTAL** - Valor total do item (quantidade √ó valor unit√°rio)

#### Exemplo de Registro:

```
CHAVE: 13250505914165000192550030000116841779221343
ITEM 1: OXIGENIO MEDICINAL - 1M3 /ONU:1072
NCM: 28044000 (Oxig√™nio)
CFOP: 6107
QUANTIDADE: 4,00 M3 √ó R$ 150,66 = R$ 602,64
```

---

## üîó Relacionamento entre Arquivos

### Modelo de Dados: 1:N (Um para Muitos)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NotaFiscal (Cabe√ßalho)  ‚îÇ
‚îÇ  1 linha = 1 nota        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ CHAVE DE ACESSO
             ‚îÇ
             ‚Üì 1:N
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NotaFiscalItem (Itens)  ‚îÇ
‚îÇ  N linhas = N produtos   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 18 Colunas em Comum (Chaves de Relacionamento):

‚úÖ **CHAVE DE ACESSO** ‚Üê **Chave prim√°ria/estrangeira**
- MODELO, S√âRIE, N√öMERO
- NATUREZA DA OPERA√á√ÉO, DATA EMISS√ÉO
- CPF/CNPJ Emitente, RAZ√ÉO SOCIAL EMITENTE
- INSCRI√á√ÉO ESTADUAL EMITENTE, UF EMITENTE, MUNIC√çPIO EMITENTE
- CNPJ DESTINAT√ÅRIO, NOME DESTINAT√ÅRIO, UF DESTINAT√ÅRIO
- INDICADOR IE DESTINAT√ÅRIO
- DESTINO DA OPERA√á√ÉO, CONSUMIDOR FINAL, PRESEN√áA DO COMPRADOR

---

## üìå Diferen√ßas Estruturais

### Colunas Exclusivas de NotaFiscal (3):

| Coluna | Descri√ß√£o | Uso |
|--------|-----------|-----|
| **EVENTO MAIS RECENTE** | Status da nota (Autoriza√ß√£o, Cancelamento, etc.) | Controle de ciclo de vida |
| **DATA/HORA EVENTO MAIS RECENTE** | Timestamp do √∫ltimo evento | Auditoria temporal |
| **VALOR NOTA FISCAL** | Soma total dos itens | **Consolida√ß√£o financeira** |

### Colunas Exclusivas de NotaFiscalItem (9):

| Coluna | Descri√ß√£o | Uso |
|--------|-----------|-----|
| **N√öMERO PRODUTO** | Sequ√™ncia do item | Identifica√ß√£o dentro da nota |
| **DESCRI√á√ÉO DO PRODUTO/SERVI√áO** | Nome completo do produto | An√°lise de cat√°logo |
| **C√ìDIGO NCM/SH** | C√≥digo fiscal | Classifica√ß√£o tribut√°ria |
| **NCM/SH (TIPO DE PRODUTO)** | Categoria do NCM | Agrupamento por tipo |
| **CFOP** | C√≥digo de opera√ß√£o | An√°lise fiscal |
| **QUANTIDADE** | Qtd comercializada | An√°lise de volume |
| **UNIDADE** | Unidade de medida | Padroniza√ß√£o |
| **VALOR UNIT√ÅRIO** | Pre√ßo unit√°rio | An√°lise de precifica√ß√£o |
| **VALOR TOTAL** | Subtotal do item | Composi√ß√£o do valor da nota |

---

## üí° Caso de Uso Pr√°tico

### Exemplo Real do Dataset:

**Nota Fiscal #11684 (CHAVE: 13250505914165000192550030000116841779221343)**

#### No arquivo NotaFiscal.csv (1 linha):
```
Emitente: CARBOXI INDUSTRIA E COMERCIO DE GASES LTDA (AM - Manaus)
Destinat√°rio: DISTRITO SANITARIO ESPECIAL INDIGENA YANOMAMI (RR)
Opera√ß√£o: Interestadual | Consumidor Final
VALOR TOTAL DA NOTA: R$ 4.603,42
Data: 01/05/2025
```

#### No arquivo NotaFiscalItem.csv (3 linhas):
```
Item 1: OXIGENIO MEDICINAL - 1M3 /ONU:1072
        NCM: 28044000 (Oxig√™nio) | CFOP: 6107
        4,00 M3 √ó R$ 150,66 = R$ 602,64

Item 2: OXIGENIO MEDICINAL - 2M3/ ONU: 1072
        NCM: 28044000 (Oxig√™nio) | CFOP: 6107
        6,00 M3 √ó R$ 150,66 = R$ 903,96

Item 3: OXIGENIO MEDICINAL - 3,5M3 /ONU 1072
        NCM: 28044000 (Oxig√™nio) | CFOP: 6107
        28,00 M3 √ó R$ 71,25 = R$ 1.995,00

SOMA DOS ITENS: R$ 4.603,42 ‚úì (confere com VALOR NOTA FISCAL)
```

---

## üéØ Quando Usar Cada Arquivo

### Use **NotaFiscal.csv** para:
- ‚úÖ An√°lise quantitativa de notas fiscais
- ‚úÖ Agrega√ß√µes por emitente/destinat√°rio
- ‚úÖ An√°lises geogr√°ficas (UF origem/destino)
- ‚úÖ An√°lises temporais (notas por per√≠odo)
- ‚úÖ Valores totais por opera√ß√£o
- ‚úÖ M√©tricas de consumidor final vs. B2B

### Use **NotaFiscalItem.csv** para:
- ‚úÖ An√°lise de produtos mais vendidos
- ‚úÖ An√°lise por NCM/categoria fiscal
- ‚úÖ Estudos de precifica√ß√£o
- ‚úÖ An√°lise de volumes e unidades
- ‚úÖ Composi√ß√£o detalhada das notas
- ‚úÖ An√°lise de CFOP (natureza das opera√ß√µes)

### Use **JOIN entre ambos** para:
- ‚úÖ An√°lise completa: "Quais produtos mais vendidos para RR?"
- ‚úÖ Compara√ß√£o: "Valor m√©dio de nota por tipo de produto"
- ‚úÖ Detec√ß√£o de anomalias: "Notas com valor total divergente da soma dos itens"
- ‚úÖ An√°lises cross-dimensionais: "NCM √ó UF Destinat√°rio √ó Per√≠odo"

---

## üîç Consulta SQL Conceitual (JOIN)

```sql
SELECT 
    nf.CHAVE_DE_ACESSO,
    nf.RAZAO_SOCIAL_EMITENTE,
    nf.UF_DESTINATARIO,
    nf.VALOR_NOTA_FISCAL,
    nfi.NUMERO_PRODUTO,
    nfi.DESCRICAO_DO_PRODUTO,
    nfi.QUANTIDADE,
    nfi.VALOR_TOTAL
FROM 
    NotaFiscal nf
INNER JOIN 
    NotaFiscalItem nfi 
    ON nf.CHAVE_DE_ACESSO = nfi.CHAVE_DE_ACESSO
WHERE 
    nf.UF_DESTINATARIO = 'RR'
    AND nfi.NCM_SH_TIPO_PRODUTO LIKE '%Oxig√™nio%'
ORDER BY 
    nf.DATA_EMISSAO DESC;
```

---

## üìä Resumo Estat√≠stico

| M√©trica | NotaFiscal | NotaFiscalItem |
|---------|-----------|----------------|
| **Tamanho** | 67.09 MB | 296.30 MB |
| **Colunas** | 21 | 27 |
| **Colunas Compartilhadas** | 18 | 18 |
| **Colunas Exclusivas** | 3 | 9 |
| **Granularidade** | Nota (agregado) | Item (detalhado) |
| **Cardinalidade** | 1 por nota | N por nota |
| **Chave Prim√°ria** | CHAVE DE ACESSO | CHAVE DE ACESSO + N√öMERO PRODUTO |

---

## üéì Conclus√£o

Estes arquivos representam um **modelo relacional cl√°ssico de nota fiscal eletr√¥nica**:

1. **NotaFiscal.csv** = **Cabe√ßalho/Master** (dados consolidados da nota)
2. **NotaFiscalItem.csv** = **Detalhe/Detail** (linha de produtos)

**Relacionamento:** 1:N via `CHAVE DE ACESSO`

**Propor√ß√£o m√©dia:** ~4.4 itens por nota (296MB / 67MB)

**Integridade referencial:** Toda linha em `NotaFiscalItem` deve ter correspond√™ncia em `NotaFiscal`

**Valida√ß√£o financeira:** `SUM(NotaFiscalItem.VALOR_TOTAL)` deve igualar `NotaFiscal.VALOR_NOTA_FISCAL` para cada chave

---

## üìù Recomenda√ß√µes para An√°lise

### Para An√°lise de Dados (Pandas/Python):
```python
import pandas as pd

# Carregar apenas cabe√ßalhos
nf = pd.read_csv('data/202505_NFe_NotaFiscal.csv', 
                 encoding='latin-1', sep=';')

nfi = pd.read_csv('data/202505_NFe_NotaFiscalItem.csv', 
                  encoding='latin-1', sep=';')

# JOIN
df_completo = nf.merge(nfi, on='CHAVE DE ACESSO', how='inner')

# Valida√ß√£o de integridade
validacao = nfi.groupby('CHAVE DE ACESSO')['VALOR TOTAL'].sum()
```

### Para Ingest√£o em Banco de Dados:
- Criar tabela `nota_fiscal` com PK em `CHAVE DE ACESSO`
- Criar tabela `nota_fiscal_item` com PK composta `(CHAVE DE ACESSO, NUMERO PRODUTO)`
- Estabelecer FK de `nota_fiscal_item` ‚Üí `nota_fiscal`
- Indexar colunas de busca frequente: `DATA EMISSAO`, `UF DESTINATARIO`, `CODIGO NCM/SH`

### Para Sistema Multiagente (LangChain/RAG):
- Embeddings separados por tipo de dado (nota vs. item)
- Metadata incluindo `CHAVE DE ACESSO` para navega√ß√£o entre documentos
- Chunks contextualizados: incluir dados do cabe√ßalho em cada item
- Queries vetoriais com filtros por UF, per√≠odo, NCM

---

**Documento gerado automaticamente via script `compare_csvs.py`**  
**Projeto:** agentnfe-backend  
**Reposit√≥rio:** roberto-fgv/agentnfe-backend
