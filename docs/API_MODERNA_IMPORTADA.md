# üöÄ API Moderna Importada - AgentNFE Backend

**Data de Importa√ß√£o:** 29 de Outubro de 2025  
**Fonte:** `ai-mindsgroup/agentnfe-backend` branch `feature/api-moderna`  
**Destino:** `roberto-fgv/agentnfe-backend` branch `main`

---

## üì¶ O Que Foi Importado?

### Arquivos Principais

**APIs Legadas (para compara√ß√£o):**
- ‚úÖ `api_completa.py` (997 linhas) - API completa porta 8001
- ‚úÖ `api_simple.py` (720 linhas) - API simples porta 8000

**Nova Estrutura Modular (app/):**
- ‚úÖ `app/main.py` (401 linhas) - API moderna v3.0.0
- ‚úÖ `app/core/` - Configura√ß√µes e seguran√ßa
- ‚úÖ `app/middleware/` - Middlewares (auth, logging, rate limiting)
- ‚úÖ `app/models/` - Modelos Pydantic
- ‚úÖ `app/routers/` - Rotas modulares

---

## üèóÔ∏è Arquitetura da API Moderna

### Estrutura Modular

```
app/
‚îú‚îÄ‚îÄ main.py                 # üöÄ Aplica√ß√£o principal
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ config.py          # Configura√ß√µes centralizadas
‚îÇ   ‚îú‚îÄ‚îÄ database.py        # Gerenciamento de conex√µes DB
‚îÇ   ‚îî‚îÄ‚îÄ security.py        # JWT, hashing, autentica√ß√£o
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.py            # Autentica√ß√£o JWT
‚îÇ   ‚îú‚îÄ‚îÄ error_handler.py   # Tratamento de erros global
‚îÇ   ‚îú‚îÄ‚îÄ logging.py         # Logging estruturado
‚îÇ   ‚îî‚îÄ‚îÄ rate_limiting.py   # Controle de taxa de requisi√ß√µes
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ agent_models.py    # Modelos Pydantic para agentes
‚îî‚îÄ‚îÄ routers/
    ‚îú‚îÄ‚îÄ agents.py          # Endpoints de agentes IA
    ‚îú‚îÄ‚îÄ data_processing.py # Processamento de dados
    ‚îú‚îÄ‚îÄ embeddings.py      # Gerenciamento de embeddings
    ‚îú‚îÄ‚îÄ fraud_detection.py # Detec√ß√£o de fraude
    ‚îî‚îÄ‚îÄ health.py          # Health checks e status
```

---

## üÜö Compara√ß√£o: API Legada vs API Moderna

| Aspecto | api_completa.py | api_simple.py | app/main.py (v3.0) |
|---------|-----------------|---------------|---------------------|
| **Linhas** | 997 | 720 | 401 (modular) |
| **Porta** | 8001 | 8000 | Configur√°vel |
| **Arquitetura** | Monol√≠tica | Monol√≠tica | Modular |
| **Autentica√ß√£o** | ‚ùå | ‚ùå | ‚úÖ JWT |
| **Rate Limiting** | ‚ùå | ‚ùå | ‚úÖ |
| **WebSocket** | ‚ùå | ‚ùå | ‚úÖ |
| **Middlewares** | B√°sico | B√°sico | Completo |
| **Seguran√ßa** | B√°sica | B√°sica | Avan√ßada |
| **Escalabilidade** | Baixa | Baixa | Alta |
| **Manutenibilidade** | Baixa | Baixa | Alta |

---

## üìã Rotas Dispon√≠veis

### API Legada (api_completa.py)

```
GET  /health              ‚Üí Status da API
POST /chat                ‚Üí Chat com IA
POST /csv/upload          ‚Üí Upload CSV
GET  /csv/files           ‚Üí Lista arquivos
POST /fraud/detect        ‚Üí Detec√ß√£o de fraude
GET  /dashboard/metrics   ‚Üí M√©tricas
GET  /agents/status       ‚Üí Status dos agentes
POST /agents/reload       ‚Üí Recarregar agentes
```

### API Moderna (app/main.py)

```
üè• Health & Status
GET  /api/v1/health       ‚Üí Health check
GET  /api/v1/status       ‚Üí Status detalhado do sistema

ü§ñ Agentes IA
GET  /api/v1/agents       ‚Üí Lista todos os agentes
POST /api/v1/agents/query ‚Üí Consulta inteligente
GET  /api/v1/agents/{id}  ‚Üí Detalhes de um agente

üìä Processamento de Dados
POST /api/v1/data/upload  ‚Üí Upload de arquivos
GET  /api/v1/data/files   ‚Üí Lista arquivos processados
GET  /api/v1/data/{id}    ‚Üí Detalhes de um arquivo

üß† Embeddings & RAG
POST /api/v1/embeddings/generate ‚Üí Gerar embeddings
GET  /api/v1/embeddings/search   ‚Üí Busca vetorial
DELETE /api/v1/embeddings/{id}   ‚Üí Remover embeddings

üõ°Ô∏è Detec√ß√£o de Fraude
POST /api/v1/fraud/analyze       ‚Üí An√°lise de fraude
GET  /api/v1/fraud/reports       ‚Üí Relat√≥rios de fraude

üîê Autentica√ß√£o
POST /api/v1/auth/login          ‚Üí Login JWT
POST /api/v1/auth/refresh        ‚Üí Renovar token
GET  /api/v1/auth/me             ‚Üí Dados do usu√°rio

üìà Analytics
GET  /api/v1/analytics/dashboard ‚Üí Dashboard completo
GET  /api/v1/analytics/metrics   ‚Üí M√©tricas em tempo real

üîÑ Tasks Ass√≠ncronas
POST /api/v1/tasks/run           ‚Üí Executar task
GET  /api/v1/tasks/{id}/status   ‚Üí Status da task
WS   /ws/tasks/{id}              ‚Üí WebSocket para atualiza√ß√µes
```

---

## üöÄ Como Usar

### 1. API Legada (Testes R√°pidos)

```bash
# API Simples (sem multiagente)
python api_simple.py
# http://localhost:8000/docs

# API Completa (com multiagente)
python api_completa.py
# http://localhost:8001/docs
```

### 2. API Moderna (Produ√ß√£o)

```bash
# Configurar ambiente
cp configs/.env.example configs/.env
# Editar configs/.env com suas credenciais

# Instalar depend√™ncias
pip install -r requirements.txt

# Executar API moderna
python app/main.py
# ou
uvicorn app.main:app --host 0.0.0.0 --port 8011 --reload

# Acessar
# http://localhost:8011/docs
```

---

## üîë Funcionalidades da API Moderna

### 1. ‚úÖ Autentica√ß√£o JWT

```python
# Login
POST /api/v1/auth/login
{
    "username": "admin",
    "password": "senha"
}
# Resposta: { "access_token": "eyJ...", "token_type": "bearer" }

# Usar token
Headers: { "Authorization": "Bearer eyJ..." }
```

### 2. ‚úÖ Rate Limiting

```python
# Limites padr√£o:
# - 100 requisi√ß√µes por minuto por IP
# - 1000 requisi√ß√µes por hora por usu√°rio

# Headers de resposta:
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 97
X-RateLimit-Reset: 1698585600
```

### 3. ‚úÖ WebSocket para Tasks Longas

```javascript
// Frontend
const ws = new WebSocket('ws://localhost:8011/ws/tasks/task-123');

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log(`Progresso: ${data.progress}%`);
};
```

### 4. ‚úÖ Middlewares Personalizados

- **Auth Middleware:** Valida JWT em rotas protegidas
- **Error Handler:** Trata erros globalmente
- **Logging:** Log estruturado de todas as requisi√ß√µes
- **Rate Limiting:** Controle de taxa por IP/usu√°rio
- **CORS:** Configura√ß√£o flex√≠vel
- **GZip:** Compress√£o autom√°tica
- **TrustedHost:** Prote√ß√£o contra host poisoning

### 5. ‚úÖ Modelos Pydantic Validados

```python
# Exemplo de modelo
class AgentQueryRequest(BaseModel):
    query: str = Field(..., min_length=1, max_length=1000)
    agent_id: Optional[str] = None
    context: Optional[Dict[str, Any]] = None
    temperature: float = Field(0.7, ge=0, le=2)
```

---

## üìä Monitoramento e Analytics

### M√©tricas Dispon√≠veis

```python
GET /api/v1/analytics/metrics
# Resposta:
{
    "requests_total": 15234,
    "requests_per_minute": 42,
    "active_users": 128,
    "active_agents": 5,
    "embeddings_count": 321000,
    "fraud_detections_today": 23,
    "avg_response_time_ms": 145,
    "error_rate": 0.02,
    "uptime_seconds": 86400
}
```

---

## üîí Seguran√ßa

### Recursos Implementados

1. **Autentica√ß√£o JWT**
   - Tokens com expira√ß√£o configur√°vel
   - Refresh tokens para renova√ß√£o
   - Revoga√ß√£o de tokens

2. **Hashing de Senhas**
   - bcrypt para senhas
   - Salt autom√°tico

3. **Rate Limiting**
   - Prote√ß√£o contra DDoS
   - Limites por IP e usu√°rio

4. **CORS**
   - Configura√ß√£o de origens permitidas
   - Headers seguros

5. **Valida√ß√£o de Input**
   - Pydantic models
   - Sanitiza√ß√£o autom√°tica

6. **HTTPS Ready**
   - Suporte TLS/SSL
   - Strict-Transport-Security

---

## üìö Documenta√ß√£o Autom√°tica

### Swagger UI
```
http://localhost:8011/docs
```

### ReDoc
```
http://localhost:8011/redoc
```

### OpenAPI JSON
```
http://localhost:8011/openapi.json
```

---

## üß™ Testes

### Testar Health Check

```bash
curl http://localhost:8011/api/v1/health

# Resposta:
{
    "status": "healthy",
    "timestamp": "2025-10-29T10:30:00Z",
    "version": "3.0.0",
    "agents": {
        "total": 5,
        "active": 5,
        "inactive": 0
    },
    "database": {
        "connected": true,
        "latency_ms": 12
    }
}
```

### Testar Autentica√ß√£o

```bash
# Login
curl -X POST http://localhost:8011/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "senha"}'

# Usar token
curl http://localhost:8011/api/v1/agents \
  -H "Authorization: Bearer eyJ..."
```

---

## üîÑ Migra√ß√£o da API Legada

### Equival√™ncia de Endpoints

| API Legada | API Moderna | Notas |
|------------|-------------|-------|
| `/health` | `/api/v1/health` | Versionamento |
| `/chat` | `/api/v1/agents/query` | Renomeado |
| `/csv/upload` | `/api/v1/data/upload` | Organizado |
| `/fraud/detect` | `/api/v1/fraud/analyze` | Renomeado |
| `/agents/status` | `/api/v1/agents` | GET em vez de status |

### Script de Migra√ß√£o

```python
# Exemplo de adapta√ß√£o
# ANTES (api_completa.py)
response = requests.post('http://localhost:8001/chat', json={'message': 'ol√°'})

# DEPOIS (API moderna)
headers = {'Authorization': f'Bearer {token}'}
response = requests.post(
    'http://localhost:8011/api/v1/agents/query',
    headers=headers,
    json={'query': 'ol√°'}
)
```

---

## üìà Roadmap

### ‚úÖ Implementado
- Sistema multiagente integrado
- Autentica√ß√£o JWT
- Rate limiting
- WebSocket para tasks
- Middlewares completos
- Documenta√ß√£o autom√°tica
- Modelos Pydantic validados

### üîÑ Em Desenvolvimento
- Cache Redis
- Message queue (Celery)
- M√©tricas Prometheus
- Tracing distribu√≠do
- API Gateway
- Service mesh

### üìã Planejado
- GraphQL endpoint
- gRPC para comunica√ß√£o interna
- Multi-tenancy
- API versioning v2
- Kubernetes deployment
- CI/CD completo

---

## üõ†Ô∏è Configura√ß√£o Avan√ßada

### Vari√°veis de Ambiente

```env
# API
API_HOST=0.0.0.0
API_PORT=8011
API_ENV=production

# Seguran√ßa
SECRET_KEY=sua_chave_secreta_super_segura
JWT_ALGORITHM=HS256
JWT_EXPIRATION_MINUTES=30

# Rate Limiting
RATE_LIMIT_PER_MINUTE=100
RATE_LIMIT_PER_HOUR=1000

# Database
SUPABASE_URL=https://seu-projeto.supabase.co
SUPABASE_KEY=sua_chave

# LLMs
GOOGLE_API_KEY=sua_chave
SONAR_API_KEY=sua_chave

# Monitoring
ENABLE_METRICS=true
ENABLE_TRACING=true
LOG_LEVEL=INFO
```

---

## üí° Boas Pr√°ticas

### 1. Sempre use a API moderna em produ√ß√£o
```python
# ‚ùå N√£o use em produ√ß√£o
python api_simple.py

# ‚úÖ Use a API moderna
python app/main.py
```

### 2. Configure autentica√ß√£o corretamente
```python
# Sempre proteja rotas sens√≠veis
@router.get("/protected")
async def protected_route(current_user: User = Depends(get_current_user)):
    return {"message": "Acesso autorizado"}
```

### 3. Use rate limiting apropriado
```python
# Ajuste limites por endpoint
@router.post("/expensive-operation")
@limiter.limit("10/minute")
async def expensive_op():
    pass
```

### 4. Monitore m√©tricas constantemente
```python
# Acompanhe health checks
while True:
    health = requests.get('/api/v1/health').json()
    if health['status'] != 'healthy':
        alert_team()
```

---

## üìû Suporte

### Documenta√ß√£o
- üìÑ README principal: `README.md`
- üìä Backlog: `docs/Backlog do Projeto.md`
- üîç Auditoria: `docs/AUDITORIA_BACKLOG_28-10-2025.md`

### Issues
- GitHub Issues: `https://github.com/roberto-fgv/agentnfe-backend/issues`

---

## üéâ Conclus√£o

A API moderna traz uma arquitetura profissional e escal√°vel, pronta para produ√ß√£o. Com autentica√ß√£o, rate limiting, WebSocket e arquitetura modular, o sistema est√° preparado para crescer e atender demandas complexas.

**Pr√≥ximos Passos:**
1. Testar a API moderna localmente
2. Configurar vari√°veis de ambiente
3. Migrar frontend para novos endpoints
4. Deploy em ambiente de produ√ß√£o
5. Configurar monitoramento e alerts

---

**√öltima Atualiza√ß√£o:** 29 de Outubro de 2025  
**Vers√£o da API:** 3.0.0  
**Status:** ‚úÖ Importada e Pronta para Uso
